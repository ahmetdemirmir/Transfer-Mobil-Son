<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Demir Kırtasiye Transfer İrsaliye Kontrol</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f7fa; text-align: center; padding: 20px; }
h1 { color: #2c3e50; display: inline-block; margin-left: 10px; }
#header { display: flex; align-items: center; justify-content: center; }
#fileInput, #manualBarcode { margin: 10px 0; padding: 14px; font-size: 18px; border-radius: 12px; width: 96%; max-width:380px; }
#cameraControls { margin: 18px 0 10px 0; display: flex; flex-wrap: wrap; justify-content: center; gap:8px;}
#cameraControls button, #cameraControls input[type=file] { font-size: 18px; padding: 13px 18px; margin: 0; border-radius: 12px; border: 1.5px solid #ccc; min-width: 130px; transition: background 0.15s, color 0.15s;}
#scanBarcodeBtn { background: linear-gradient(90deg,#4CAF50,#77dd77); color:#fff; border:none;}
#cameraSwitchBtn { background: linear-gradient(90deg,#1976D2,#65b1fc); color:#fff; border:none;}
#saveJsonBtn, #loadJsonBtn { background: linear-gradient(90deg,#0097A7,#00BCD4); color:#fff; border:none;}
#missingBtn { background: linear-gradient(90deg,#ffb300,#ff8c00); color:#fff; border:none; margin:0 4px;}
#printBtn { background: linear-gradient(90deg,#607d8b,#a7b3c1); color:#fff; border:none;}
#exportBtn { background: linear-gradient(90deg,#9c27b0,#ce93d8); color:#fff; border:none;}
#resetBtn { background: linear-gradient(90deg,#e53935,#e57373); color:#fff; border:none;}
#qr-reader { width:95vw; max-width:400px; margin:10px auto 20px auto; display:none; border-radius:18px; box-shadow:0 0 10px #bbb;}
#progress { font-size: 20px; font-weight: bold; margin: 14px; color: #333; }
#productList { margin-top: 20px; text-align: left; }
.item { display: flex; justify-content: space-between; padding: 16px; margin: 8px 0; border-bottom: 1px solid #ddd; background-color: #e74c3c; color: #fff; font-size: 20px; cursor: pointer; border-radius: 10px;}
.scanned { background-color: #2ecc71 !important; color: #fff; text-decoration: line-through; }
.incorrect { background-color: #f39c12 !important; color: #fff; text-decoration: none; }
#popupOverlay, #missingOverlay, #doneOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999; }
#popupContent, #missingContent, #doneContent { background: #2ecc71; color: white; padding: 30px; border-radius: 18px; width: 90vw; max-width: 500px; text-align: center; position: relative; }
#popupContent h2, #missingContent h2, #doneContent h2 { font-size: 30px; margin-bottom: 17px; }
#popupContent h3 { font-size: 22px; margin-bottom: 12px; }
.popup-btn { padding: 13px 28px; font-size: 20px; border: none; border-radius: 10px; margin: 7px; cursor: pointer; }
#correctBtn { background: linear-gradient(90deg,#43A047,#A5D6A7); color: white; }
#incorrectBtn { background: linear-gradient(90deg,#e74c3c,#ff7675); color: white; }
#closePopupBtn, #closeMissingBtn { position: absolute; top: 8px; right: 12px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 34px; height: 34px; cursor: pointer; font-weight: bold; font-size: 21px; }
#missingList { max-height: 340px; overflow-y: auto; background: #fff; color: #333; padding: 13px; border-radius: 10px; margin-top: 10px; text-align:left; }
input.qty-input { width: 65px; margin-left: 12px; font-size:18px;}
#searchResults { margin-top:8px; }
#searchResults .item { background: #3498db; color: #fff; border-radius:7px; font-size:18px; cursor:pointer;}
#searchResults .item:hover { background:#2980b9;}
@media (max-width: 600px) {
  #cameraControls { flex-direction: column; gap:12px; }
  #cameraControls button { min-width: 90vw; font-size: 22px; }
  .popup-btn { font-size: 22px; padding: 16px 8vw; }
  #popupContent, #missingContent, #doneContent { padding:10vw 2vw; }
  #productList .item { font-size: 18px; padding: 14px 6px;}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<div id="header">
<h1>Demir Kırtasiye Transfer İrsaliye Kontrol</h1>
</div>

<div id="progress">✔️ 0 / 0 ürün tamamlandı</div>

<input type="file" id="fileInput" accept=".xlsx,.csv"><br>
<input type="text" id="manualBarcode" placeholder="Barkod/isim yazın, Enter’a basın veya kamerayla okutun" autocomplete="off" readonly style="background:#eee;"><br>

<div id="cameraControls">
  <button id="scanBarcodeBtn">📷 Kamera ile Okut</button>
  <button id="cameraSwitchBtn" style="display:none;">🔄 Kamerayı Değiştir</button>
  <button id="saveJsonBtn">💾 Veriyi Kaydet (JSON)</button>
  <input type="file" id="loadJsonInput" style="display:none" accept=".json" />
  <button id="loadJsonBtn">📂 Veriyi Yükle (JSON)</button>
  <button id="missingBtn">Eksikleri Göster</button>
  <button id="printBtn">Yazdır</button>
  <button id="exportBtn">📥 Excel’e Aktar</button>
  <button id="resetBtn">🔄 Sıfırla</button>
</div>
<div id="qr-reader"></div>

<div id="productList"></div>
<div id="searchResults"></div>

<!-- Popup -->
<div id="popupOverlay">
<div id="popupContent">
<button id="closePopupBtn">×</button>
<h2 id="popupProductName"></h2>
<h3 id="popupBarcode"></h3>
<h3 id="popupProductQty"></h3>
<button id="correctBtn" class="popup-btn">Adet Doğru</button>
<button id="incorrectBtn" class="popup-btn">Adet Hatalı</button>
</div>
</div>

<!-- Eksikler Popup -->
<div id="missingOverlay">
<div id="missingContent">
<button id="closeMissingBtn">×</button>
<h2>Eksik Ürünler</h2>
<div id="missingList"></div>
</div>
</div>

<!-- Tamamlandı Popup -->
<div id="doneOverlay">
<div id="doneContent">
<h2>✅ İrsaliye Tamamlandı!</h2>
</div>
</div>

<audio id="beepSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa818f.mp3" preload="auto"></audio>
<audio id="failSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_123bfeeb1a.mp3" preload="auto"></audio>

<script>
let products = [];
let currentProduct = null;
const STORAGE_KEY = "demir_kirtasiye_scan_data";
const manualBarcode = document.getElementById('manualBarcode');
const progressEl = document.getElementById('progress');
const popupOverlay = document.getElementById('popupOverlay');
const popupProductName = document.getElementById('popupProductName');
const popupBarcode = document.getElementById('popupBarcode');
const popupProductQty = document.getElementById('popupProductQty');
const correctBtn = document.getElementById('correctBtn');
const incorrectBtn = document.getElementById('incorrectBtn');
const closePopupBtn = document.getElementById('closePopupBtn');
const productList = document.getElementById('productList');
const missingBtn = document.getElementById('missingBtn');
const missingOverlay = document.getElementById('missingOverlay');
const missingList = document.getElementById('missingList');
const closeMissingBtn = document.getElementById('closeMissingBtn');
const doneOverlay = document.getElementById('doneOverlay');
const resetBtn = document.getElementById('resetBtn');
const beep = document.getElementById('beepSound');
const fail = document.getElementById('failSound');
const searchResults = document.getElementById('searchResults');

// Mobil tespiti
let isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);

// Kamera & JSON Plug & Play
let qrScanner;
let qrScannerActive = false;
let currentFacingMode = "environment"; // "environment" (arka), "user" (ön)
const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
const qrReaderDiv = document.getElementById('qr-reader');

// Ses + titreşim fonksiyonu
function playBeepAndVibrate(success = true) {
  try {
    if(success){ beep.currentTime = 0; beep.play(); }
    else { fail.currentTime = 0; fail.play(); }
  } catch {}
  if (navigator.vibrate) navigator.vibrate(success ? 100 : [80,60,80]);
}

// Klavye yönetimi
function setBarcodeInputReadonly(state) {
  manualBarcode.readOnly = state;
  manualBarcode.style.background = state ? "#eee" : "#fff";
  if (!state && isMobile) setTimeout(() => { manualBarcode.focus(); }, 200);
  if (state && isMobile) manualBarcode.blur();
}

// Kamera Aç/Kapat Butonu
scanBarcodeBtn.addEventListener('click', () => {
  if (!qrScannerActive) {
    qrReaderDiv.style.display = 'block';
    scanBarcodeBtn.textContent = 'Kamerayı Kapat';
    cameraSwitchBtn.style.display = 'inline-block';
    qrScannerActive = true;
    setBarcodeInputReadonly(true);
    startQrScanner();
  } else {
    stopQrScanner();
  }
});
cameraSwitchBtn.addEventListener('click', () => {
  currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
  stopQrScanner(true);
  setTimeout(() => startQrScanner(), 100);
});
function startQrScanner() {
  qrScanner = new Html5Qrcode("qr-reader");
  qrScanner.start(
    { facingMode: currentFacingMode },
    { fps: 15, qrbox: 250 },
    code => {
      playBeepAndVibrate();
      manualBarcode.value = code;
      searchAndShowPopup(code, true);
    },
    errorMessage => { }
  );
}
function stopQrScanner(resetOnly = false) {
  if (qrScanner) {
    qrScanner.stop().then(() => {
      if (!resetOnly) {
        qrReaderDiv.style.display = 'none';
        scanBarcodeBtn.textContent = '📷 Kamera ile Okut';
        cameraSwitchBtn.style.display = 'none';
        qrScannerActive = false;
        setBarcodeInputReadonly(false);
      }
    }).catch(() => {});
  }
}

// JSON Kaydet/Yükle
document.getElementById('saveJsonBtn').addEventListener('click', () => {
  const dataStr = JSON.stringify(products, null, 2);
  const blob = new Blob([dataStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'irsaliye_durum.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
document.getElementById('loadJsonBtn').addEventListener('click', () => {
  document.getElementById('loadJsonInput').click();
});
document.getElementById('loadJsonInput').addEventListener('change', function(evt){
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      products = JSON.parse(e.target.result);
      saveToLocalStorage();
      renderProducts();
      alert("JSON başarıyla yüklendi ve uygulandı!");
    } catch {
      alert("Geçersiz JSON dosyası!");
    }
  };
  reader.readAsText(file);
});

// Core logic
document.getElementById('fileInput').addEventListener('change', handleFile);
closePopupBtn.addEventListener('click', () => { popupOverlay.style.display = 'none'; manualBarcode.focus(); currentProduct = null; });
closeMissingBtn.addEventListener('click', () => { missingOverlay.style.display = 'none'; manualBarcode.focus(); });
resetBtn.addEventListener('click', () => {
  if(confirm("Tüm işaretlemeleri sıfırlamak istediğine emin misin?")) {
    products.forEach(p => { p.scanned = false; });
    saveToLocalStorage();
    renderProducts();
  }
});

function saveToLocalStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
}
function loadFromLocalStorage() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) { try { return JSON.parse(data); } catch { return null; } }
  return null;
}
function handleFile(event) {
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    products = XLSX.utils.sheet_to_json(sheet, {defval: ""});
    const saved = loadFromLocalStorage();
    if (saved) {
      products.forEach(p => {
        const match = saved.find(s => s.Barkodu === p.Barkodu);
        if (match) { p.scanned = match.scanned; } else { p.scanned = false; }
      });
    } else {
      products.forEach(p => { p.scanned = false; });
    }
    renderProducts();
  };
  reader.readAsArrayBuffer(file);
}
function renderProducts(list = null) {
  const data = list || products;
  productList.innerHTML = '';
  data.forEach(p => {
    const barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
    const urunAdi = p["Stok Adı"] || p["STOK ADI"] || "";
    const adet = p.Miktarı || p["Miktar"] || p["MİKTARI"] || "";
    const div = document.createElement('div');
    div.className = 'item';
    div.setAttribute('data-barcode', barkod);
    if (p.scanned === true) { div.classList.add('scanned'); }
    else if (p.scanned === false && div.classList.contains('incorrect')) { div.classList.add('incorrect'); }
    div.innerHTML = `<span><b>${barkod}</b> - ${urunAdi}</span><span><b>${adet} ADET</b></span>`;
    div.addEventListener('click', () => openPopup(p));
    productList.appendChild(div);
  });
  updateCounter();
}
function markAsScanned(code) {
  let found = searchProduct(code);
  if (!found) {
    playBeepAndVibrate(false);
    alert("❌ Bu ürün listede yok!");
    return;
  }
  openPopup(found);
}
function openPopup(product) {
  currentProduct = product;
  popupProductName.textContent = product["Stok Adı"] || "Ürün Adı Yok";
  popupBarcode.textContent = "Barkod: " + (product.Barkodu || product["BARKODU"] || product["Barkod"] || "");
  popupProductQty.textContent = "Olması Gereken: " + (product.Miktarı || "") + " ADET";
  popupOverlay.style.display = 'flex';
}
correctBtn.addEventListener('click', () => {
  if (currentProduct) {
    currentProduct.scanned = true;
    const itemDiv = document.querySelector(`[data-barcode='${currentProduct.Barkodu}']`);
    if (itemDiv) { itemDiv.classList.remove('incorrect'); itemDiv.classList.add('scanned'); }
    saveToLocalStorage();
    popupOverlay.style.display = 'none';
    updateCounter();
    checkIfDone();
    manualBarcode.focus();
    currentProduct = null;
    // Kamera aktifse onay sonrası tekrar aç (kesintisiz iş akışı)
    if (qrScannerActive) {
      setTimeout(()=>{ startQrScanner(); },350);
    }
  }
});
incorrectBtn.addEventListener('click', () => {
  if (currentProduct) {
    currentProduct.scanned = false;
    const itemDiv = document.querySelector(`[data-barcode='${currentProduct.Barkodu}']`);
    if (itemDiv) { itemDiv.classList.remove('scanned'); itemDiv.classList.add('incorrect'); }
    saveToLocalStorage();
    popupOverlay.style.display = 'none';
    updateCounter();
    manualBarcode.focus();
    currentProduct = null;
    if (qrScannerActive) {
      setTimeout(()=>{ startQrScanner(); },350);
    }
  }
});
missingBtn.addEventListener('click', () => {
  missingList.innerHTML = '';
  const eksikler = products.filter(p => p.scanned !== true);
  if (eksikler.length === 0) {
    missingList.innerHTML = "<p>Tüm ürünler tamamlandı ✅</p>";
  } else {
    eksikler.forEach(p => {
      const div = document.createElement('div');
      div.innerHTML = `${p.Barkodu} - ${p["Stok Adı"]} (${p.Miktarı} ADET)
      <input type="number" class="qty-input" placeholder="Gelen" />`;
      missingList.appendChild(div);
    });
  }
  missingOverlay.style.display = 'flex';
});
document.getElementById('printBtn').addEventListener('click', () => {
  const eksikler = products.filter(p => p.scanned !== true);
  let printWindow = window.open('', '', 'height=800,width=600');
  printWindow.document.write('<html><head><title>Eksik Ürünler</title></head><body>');
  printWindow.document.write('<h2>Eksik Ürünler Listesi</h2><ul>');
  eksikler.forEach(p => {
    printWindow.document.write(`<li>${p.Barkodu} - ${p["Stok Adı"]} (${p.Miktarı} ADET)</li>`);
  });
  printWindow.document.write('</ul></body></html>');
  printWindow.document.close();
  printWindow.print();
});
document.getElementById('exportBtn').addEventListener('click', () => {
  const exportData = products.map(p => ({
    Barkod: p.Barkodu,
    "Ürün Adı": p["Stok Adı"],
    Durum: p.scanned ? "Doğru" : "Hatalı",
    "Olması Gereken": p.Miktarı
  }));
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Kontrol Listesi");
  XLSX.writeFile(wb, "irsaliye_kontrol.xlsx");
});
function updateCounter() {
  const total = products.length;
  const done = products.filter(p => p.scanned === true).length;
  progressEl.textContent = `✔️ ${done} / ${total} ürün tamamlandı`;
}
function checkIfDone() {
  const total = products.length;
  const done = products.filter(p => p.scanned === true).length;
  if (total > 0 && done === total) {
    doneOverlay.style.display = 'flex';
    setTimeout(()=> doneOverlay.style.display='none', 3000);
  }
}

// -- AKILLI ARAMA (barkod son 6, isim, tam barkod)
function searchProduct(term) {
  if (!term) return null;
  term = term.trim().toLowerCase();
  let found = products.find(p => 
    String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "").toLowerCase() === term ||
    String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "").toLowerCase().slice(-6) === term
  );
  if (found) return found;
  found = products.find(p => 
    (p["Stok Adı"] || p["STOK ADI"] || "").toLowerCase().includes(term)
  );
  return found || null;
}
// -- Canlı Akıllı Arama ve Hızlı Popup
manualBarcode.addEventListener('input', function(e) {
  if (qrScannerActive) return; // Kamera açıkken arama çalışmasın
  let val = manualBarcode.value.trim().toLowerCase();
  if (!val || !products.length) { searchResults.innerHTML = ""; return; }
  let results = products.filter(p => {
    let barkod = String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "").toLowerCase();
    let urunAdi = (p["Stok Adı"] || p["STOK ADI"] || "").toLowerCase();
    return barkod.includes(val) || barkod.slice(-6).includes(val) || urunAdi.includes(val);
  });
  if (results.length === 1 && (val.length > 2)) {
    openPopup(results[0]);
    searchResults.innerHTML = "";
    manualBarcode.value = "";
    playBeepAndVibrate();
    return;
  }
  if (results.length) {
    searchResults.innerHTML = results.slice(0,8).map(p=>{
      let barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
      let urunAdi = p["Stok Adı"] || p["STOK ADI"] || "";
      let adet = p.Miktarı || p["Miktar"] || p["MİKTARI"] || "";
      return `<div class="item" onclick="window._popupByIdx(${products.indexOf(p)})"><b>${barkod}</b> - ${urunAdi} <b>(${adet})</b></div>`
    }).join('');
  } else {
    searchResults.innerHTML = "<div class='item' style='background:#e74c3c'>Sonuç bulunamadı.</div>";
  }
});
window._popupByIdx = idx => {
  let p = products[idx];
  if (p) {
    openPopup(p);
    manualBarcode.value = "";
    searchResults.innerHTML = "";
    playBeepAndVibrate();
  }
};
manualBarcode.addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && !qrScannerActive) {
    let code = manualBarcode.value.trim();
    manualBarcode.value = '';
    if (code !== '') {
      searchAndShowPopup(code, false);
    }
  }
});
function searchAndShowPopup(val, fromCamera = false) {
  let found = searchProduct(val);
  if (!found) {
    playBeepAndVibrate(false);
    alert("❌ Bu ürün listede yok!");
    // Kamera workflow'unda yanlış okutulduysa hemen tekrar kamera başlasın
    if (fromCamera && qrScannerActive) setTimeout(()=>{ startQrScanner(); },400);
    return;
  }
  openPopup(found);
  playBeepAndVibrate();
}

</script>
</body>
</html>
