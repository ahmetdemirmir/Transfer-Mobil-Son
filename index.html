<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Demir Kırtasiye Transfer İrsaliye Kontrol</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; text-align: center; padding: 20px; }
  h1 { color: #2c3e50; display: inline-block; margin-left: 10px; }
  #header { display: flex; align-items: center; justify-content: center; gap:12px; }
  #logo { height: 56px; object-fit: contain; }
  #fileInput, #manualBarcode, #quickSearch { margin: 10px 0; padding: 14px; font-size: 18px; border-radius: 12px; width: 96%; max-width:380px; }
  #cameraControls { margin: 18px 0 10px 0; display: flex; flex-wrap: wrap; justify-content: center; gap:8px;}
  #cameraControls button, #cameraControls input[type=file] { font-size: 18px; padding: 13px 18px; margin: 0; border-radius: 12px; border: 1.5px solid #ccc; min-width: 130px; transition: background 0.15s, color 0.15s;}
  #scanBarcodeBtn { background: linear-gradient(90deg,#4CAF50,#77dd77); color:#fff; border:none;}
  #cameraSwitchBtn { background: linear-gradient(90deg,#1976D2,#65b1fc); color:#fff; border:none;}
  #saveJsonBtn, #loadJsonBtn, #mergeJsonBtn { background: linear-gradient(90deg,#0097A7,#00BCD4); color:#fff; border:none;}
  #missingBtn { background: linear-gradient(90deg,#ffb300,#ff8c00); color:#fff; border:none; margin:0 4px;}
  #printBtn { background: linear-gradient(90deg,#607d8b,#a7b3c1); color:#fff; border:none;}
  #exportBtn { background: linear-gradient(90deg,#9c27b0,#ce93d8); color:#fff; border:none;}
  #resetBtn { background: linear-gradient(90deg,#e53935,#e57373); color:#fff; border:none;}
  /* Inline scanner — no modal */
  #qr-reader { width:95vw; max-width:480px; margin:10px auto 6px auto; display:none; border-radius:12px; overflow:hidden; box-shadow:0 0 10px #bbb; background:#000; }
  #qr-hint { font-size:12px; color:#334155; margin-bottom:8px; display:none; }
  #progress { font-size: 20px; font-weight: bold; margin: 14px; color: #333; }
  #productList { margin-top: 8px; text-align: left; }
  .item { display: flex; justify-content: space-between; padding: 16px; margin: 8px 0; border-bottom: 1px solid #ddd; background-color: #e74c3c; color: #fff; font-size: 20px; cursor: pointer; border-radius: 10px;}
  .scanned { background-color: #2ecc71 !important; color: #fff; text-decoration: line-through; }
  .incorrect { background-color: #f39c12 !important; color: #fff; text-decoration: none; }
  #popupOverlay, #missingOverlay, #doneOverlay, #errorOverlay, #replaceOverlay, #incorrectOverlay, #approvedOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999; }
  #popupContent, #missingContent, #doneContent { background: #2ecc71; color: white; padding: 30px; border-radius: 18px; width: 90vw; max-width: 500px; text-align: center; position: relative; }
  #popupContent h2, #missingContent h2, #doneContent h2 { font-size: 30px; margin-bottom: 17px; }
  #popupContent h3 { font-size: 22px; margin-bottom: 12px; }
  .popup-btn { padding: 13px 28px; font-size: 20px; border: none; border-radius: 10px; margin: 7px; cursor: pointer; }
  #correctBtn { background: linear-gradient(90deg,#FBC02D,#FFF176); color: #000; }
  #incorrectBtn { background: linear-gradient(90deg,#e74c3c,#ff7675); color: white; }
  #closePopupBtn, #closeMissingBtn, .overlay-close { position: absolute; top: 8px; right: 12px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 34px; height: 34px; cursor: pointer; font-weight: bold; font-size: 21px; }
  #missingList { max-height: 340px; overflow-y: auto; background: #fff; color: #333; padding: 13px; border-radius: 10px; margin-top: 10px; text-align:left; }
  input.qty-input { width: 80px; margin-left: 12px; font-size:18px;}
  #searchResults { margin-top:8px; }
  #searchResults .item { background: #3498db; color: #fff; border-radius:7px; font-size:18px; cursor:pointer;}
  #searchResults .item:hover { background:#2980b9;}

  /* Tuning */
  #tuningPanel { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin: 6px 0 12px; }
  #tuningPanel .group { background:#fff; border:1px solid #dcdcdc; border-radius:12px; padding:10px 12px; display:flex; align-items:center; gap:8px; }
  #tuningPanel label { font-size:14px; color:#334155; }
  #camZoomRange, #camExposureRange, #soundVolume { width: 180px; }

  @media (max-width: 600px) {
    #cameraControls { flex-direction: column; gap:12px; }
    #cameraControls button { min-width: 90vw; font-size: 22px; }
    .popup-btn { font-size: 22px; padding: 16px 8vw; }
    #popupContent, #missingContent, #doneContent { padding:10vw 2vw; }
    #productList .item { font-size: 18px; padding: 14px 6px;}
  }
</style>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
<!-- Html5Qrcode -->
<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div id="header">
    <img id="logo" src="logo.png" alt="Demir Kırtasiye Logosu">
    <h1>Demir Kırtasiye Transfer İrsaliye Kontrol</h1>
  </div>

  <div id="progress">✔️ 0 / 0 ürün tamamlandı</div>

  <input type="file" id="fileInput" accept=".xlsx,.csv"><br>
  <input type="text" id="quickSearch" placeholder="Hızlı Arama (son 6 / isim) — Kamera açıkken de çalışır" autocomplete="off"><br>
  <input type="text" id="manualBarcode" placeholder="Barkodu okutun" autocomplete="off"><br>

  <div id="cameraControls">
    <button id="scanBarcodeBtn">📷 Kamera ile Okut</button>
    <button id="cameraSwitchBtn" style="display:none;">🔄 Kamerayı Değiştir</button>
    <button id="saveJsonBtn">💾 Veriyi Kaydet (JSON)</button>
    <input type="file" id="loadJsonInput" style="display:none" accept=".json" />
    <button id="loadJsonBtn">📂 Veriyi Yükle (JSON)</button>
    <input type="file" id="mergeJsonInput" style="display:none" accept=".json" multiple />
    <button id="mergeJsonBtn">🔀 JSON Birleştir</button>
    <button id="missingBtn">Eksikleri Göster</button>
    <button id="printBtn">Yazdır</button>
    <button id="exportBtn">📥 Excel’e Aktar</button>
    <button id="resetBtn">🔄 Sıfırla</button>
  </div>

  <!-- INLINE SCANNER (no modal) -->
  <div id="qr-reader"></div>
  <div id="qr-hint">EAN‑13/UPC odaklamak için telefonu sabit tutun.</div>

  <div id="productList"></div>
  <div id="searchResults"></div>

  <!-- Doğrulama Popup -->
  <div id="popupOverlay">
    <div id="popupContent">
      <button id="closePopupBtn">×</button>
      <h2 id="popupProductName"></h2>
      <h3 id="popupBarcode"></h3>
      <h3 id="popupProductQty" style="color:#e53935;"></h3>
      <button id="correctBtn" class="popup-btn">Adet Doğru</button>
      <button id="incorrectBtn" class="popup-btn">Adet Hatalı</button>
    </div>
  </div>

  <!-- Eksikler Popup -->
  <div id="missingOverlay">
    <div id="missingContent">
      <button id="closeMissingBtn">×</button>
      <h2>Hatalı Ürünler</h2>
      <div id="missingList"></div>
      <div style="margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <button id="btnExportPdf">📄 PDF Aktar</button>
        <button id="btnPrintMissing">🖨️ Yazdır</button>
      </div>
    </div>
  </div>

  <!-- Tamamlandı Popup -->
  <div id="doneOverlay">
    <div id="doneContent">
      <h2>✅ İrsaliye Tamamlandı!</h2>
    </div>
  </div>

  <!-- Kırmızı Hata Popup -->
  <div id="errorOverlay">
    <div id="errorContent" style="background:#e74c3c; color:#fff; padding:30px; border-radius:18px; width:90vw; max-width:520px; text-align:center; position:relative;">
      <button class="overlay-close" id="closeErrorBtn">×</button>
      <h2>❌ Hata</h2>
      <p id="errorText">Bu ürün listede yok.</p>
    </div>
  </div>

  <!-- Onaylı Ürün Tekrar Okutma Popup -->
  <div id="approvedOverlay">
    <div id="approvedContent" style="background:#607d8b; color:#fff; padding:30px; border-radius:18px; width:90vw; max-width:500px; text-align:center; position:relative;">
      <button class="overlay-close" id="closeApprovedBtn">×</button>
      <h2>✅ Bu ürün daha önce onaylandı</h2>
      <p id="approvedText">Kontrol edildi ve onaylandı. Hata bildirmek ister misin?</p>
      <div style="margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <button id="approvedReportBtn" class="popup-btn">Hata Bildir</button>
        <button id="approvedDismissBtn" class="popup-btn">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Excel Yeniden Yükleme Uyarısı -->
  <div id="replaceOverlay">
    <div id="replaceContent" style="background:#c0392b; color:#fff; padding:30px; border-radius:18px; width:92vw; max-width:560px; text-align:center; position:relative;">
      <button class="overlay-close" id="closeReplaceBtn">×</button>
      <h2>⚠️ Yeni Dosya Yükleme Uyarısı</h2>
      <p>Şu an bir liste ile çalışıyorsunuz. Yeni bir Excel yüklerseniz, mevcut ilerlemeniz <b>yeni veriye göre sıfırlanır</b>.<br>
      Devam etmeden önce ilerlemenizi güvenceye almak için <b>JSON olarak kaydetmenizi</b> öneririz.</p>
      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <button id="btnSaveJsonInPopup" style="border:none; border-radius:12px; padding:12px 18px; font-size:18px; cursor:pointer; background:#0097A7; color:#fff;">💾 JSON Kaydet</button>
        <button id="btnContinueReplace" style="border:none; border-radius:12px; padding:12px 18px; font-size:18px; cursor:pointer; background:#2ecc71; color:#fff;">Devam Et</button>
        <button id="btnCancelReplace" style="border:none; border-radius:12px; padding:12px 18px; font-size:18px; cursor:pointer; background:#7f8c8d; color:#fff;">İptal</button>
      </div>
    </div>
  </div>

  <!-- Hatalı Detay Pop-up -->
  <div id="incorrectOverlay">
    <div id="incorrectBox" style="background:#f39c12; color:#fff; padding:26px; border-radius:18px; width:92vw; max-width:560px; text-align:center; position:relative;">
      <button class="overlay-close" id="closeIncorrectBtn">×</button>
      <h2>Hatalı İşaretle — Detay</h2>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Ürün:</label>
        <input type="text" id="incProductName" readonly>
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Barkod:</label>
        <input type="text" id="incBarcode" readonly>
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Gelmesi Gereken:</label>
        <input type="number" id="incExpected" readonly>
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Gelen Adet:</label>
        <input type="number" id="incReceived" placeholder="Personel girişi" min="0">
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Hata Bildiren:</label>
        <input type="text" id="incReporter" placeholder="Ad Soyad">
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Hata Tipi:</label>
        <select id="incType">
          <option value="">Seçiniz</option>
          <option>Eksik</option>
          <option>Fazla</option>
          <option>Yanlış Ürün</option>
          <option>Hasarlı</option>
        </select>
      </div>
      <div class="form-row" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0;">
        <label style="min-width:170px; font-weight:bold;">Açıklama:</label>
        <textarea id="incNote" rows="2" placeholder="Not (opsiyonel)"></textarea>
      </div>
      <div>
        <button id="btnSaveIncorrect">Kaydet</button>
        <button id="btnCancelIncorrect">Vazgeç</button>
      </div>
    </div>
  </div>

  <audio id="beepSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa818f.mp3" preload="auto"></audio>
  <audio id="failSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_123bfeeb1a.mp3" preload="auto"></audio>

<script>
(function(){
  // ==== State ====
  let products = [];
  let currentProduct = null;
  let pendingFileForReplace = null;

  const STORAGE_KEY = "demir_kirtasiye_scan_data";

  const manualBarcode = document.getElementById('manualBarcode');
  const quickSearch = document.getElementById('quickSearch');
  const progressEl = document.getElementById('progress');
  const popupOverlay = document.getElementById('popupOverlay');
  const popupProductName = document.getElementById('popupProductName');
  const popupBarcode = document.getElementById('popupBarcode');
  const popupProductQty = document.getElementById('popupProductQty');
  const correctBtn = document.getElementById('correctBtn');
  const incorrectBtn = document.getElementById('incorrectBtn');
  const closePopupBtn = document.getElementById('closePopupBtn');
  const productList = document.getElementById('productList');

  const missingBtn = document.getElementById('missingBtn');
  const missingOverlay = document.getElementById('missingOverlay');
  const missingList = document.getElementById('missingList');
  const closeMissingBtn = document.getElementById('closeMissingBtn');
  const btnExportPdf = document.getElementById('btnExportPdf');
  const btnPrintMissing = document.getElementById('btnPrintMissing');

  const doneOverlay = document.getElementById('doneOverlay');
  const resetBtn = document.getElementById('resetBtn');
  const beep = document.getElementById('beepSound');
  const fail = document.getElementById('failSound');
  const searchResults = document.getElementById('searchResults');

  const errorOverlay = document.getElementById('errorOverlay');
  const approvedOverlay = document.getElementById('approvedOverlay');
  const closeErrorBtn = document.getElementById('closeErrorBtn');

  const replaceOverlay = document.getElementById('replaceOverlay');
  const closeReplaceBtn = document.getElementById('closeReplaceBtn');
  const btnSaveJsonInPopup = document.getElementById('btnSaveJsonInPopup');
  const btnContinueReplace = document.getElementById('btnContinueReplace');
  const btnCancelReplace = document.getElementById('btnCancelReplace');

  const incorrectOverlay = document.getElementById('incorrectOverlay');
  const closeIncorrectBtn = document.getElementById('closeIncorrectBtn');
  const incProductName = document.getElementById('incProductName');
  const incBarcode = document.getElementById('incBarcode');
  const incExpected = document.getElementById('incExpected');
  const incReceived = document.getElementById('incReceived');
  const incReporter = document.getElementById('incReporter');
  const incType = document.getElementById('incType');
  const incNote = document.getElementById('incNote');

  // Tuning
  const camZoomRange = document.getElementById('camZoomRange');
  const camExposureRange = document.getElementById('camExposureRange');
  const soundVolume = document.getElementById('soundVolume');
  const vibPattern = document.getElementById('vibPattern');

  // Mobil tespiti
  const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);

  // ==== Camera (Inline, non-modal) ====
  let qrScanner = null;
  let qrScannerActive = false;
  let currentFacingMode = "environment";
  let currentTrack = null;
  const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
  const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');
  const qrReaderDiv = document.getElementById('qr-reader');
  const qrHint = document.getElementById('qr-hint');

  // Ses + titreşim
  let volumeLevel = 1.0;
  let vibMode = 'short';
  soundVolume.addEventListener('input', () => {
    volumeLevel = parseFloat(soundVolume.value);
    try { beep.volume = volumeLevel; fail.volume = volumeLevel; } catch {}
  });
  vibPattern.addEventListener('change', () => { vibMode = vibPattern.value; });

  function vibrate(success = true){
    if (!navigator.vibrate) return;
    if (vibMode === 'off') return;
    if (vibMode === 'short') navigator.vibrate(success ? 100 : [80,60,80]);
    else navigator.vibrate(success ? [120,80,120] : [150,120,150]);
  }
  function playBeep(success = true) {
    try {
      (success ? beep : fail).volume = volumeLevel;
      (success ? beep : fail).currentTime = 0;
      (success ? beep : fail).play();
    } catch {}
  }

  function setBarcodeInputReadonly(state) {
    manualBarcode.readOnly = state;
    manualBarcode.style.background = state ? "#eee" : "#fff";
    if (!state && isMobile) setTimeout(() => { manualBarcode.focus(); }, 200);
    if (state && isMobile) manualBarcode.blur();
  }

  function captureTrackAndSetupTuning(){
    const video = document.querySelector('#qr-reader video');
    if (!video || !video.srcObject) return;
    const tracks = video.srcObject.getVideoTracks();
    if (!tracks || !tracks[0]) return;
    currentTrack = tracks[0];
    const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};

    // Zoom
    if (caps.zoom !== undefined) {
      camZoomRange.min = caps.zoom.min ?? 1;
      camZoomRange.max = caps.zoom.max ?? 1;
      camZoomRange.step = caps.zoom.step ?? 0.1;
      camZoomRange.disabled = false;
      camZoomRange.oninput = async () => {
        try { await currentTrack.applyConstraints({ advanced: [{ zoom: parseFloat(camZoomRange.value) }] }); } catch {}
      };
    } else camZoomRange.disabled = true;

    // Exposure
    if (caps.exposureCompensation !== undefined) {
      camExposureRange.min = caps.exposureCompensation.min ?? -2;
      camExposureRange.max = caps.exposureCompensation.max ?? 2;
      camExposureRange.step = caps.exposureCompensation.step ?? 0.1;
      camExposureRange.disabled = false;
      camExposureRange.oninput = async () => {
        try { await currentTrack.applyConstraints({ advanced: [{ exposureCompensation: parseFloat(camExposureRange.value) }] }); } catch {}
      };
    } else camExposureRange.disabled = true;
  }

  async function startCamera(){
    if (qrScannerActive) return;
    qrReaderDiv.style.display = 'block';
    qrHint.style.display = 'block';
    scanBarcodeBtn.textContent = 'Kamerayı Kapat';
    cameraSwitchBtn.style.display = 'inline-block';
    setBarcodeInputReadonly(true);

    if (isMobile && document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }

    qrScanner = new Html5Qrcode("qr-reader");
    const config = { fps: 15, qrbox: 250, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.EAN_8 ] };

    let facingConstraint = { facingMode: currentFacingMode };
    try {
      await qrScanner.start(facingConstraint, config, onScanSuccess, onScanError);
    } catch (e) {
      // iOS fallback
      try {
        facingConstraint = { facingMode: { exact: currentFacingMode } };
        await qrScanner.start(facingConstraint, config, onScanSuccess, onScanError);
      } catch (e2) {
        // final fallback: no facingMode
        await qrScanner.start({}, config, onScanSuccess, onScanError);
      }
    }
    qrScannerActive = true;
    setTimeout(captureTrackAndSetupTuning, 200);
  }

  async function stopCamera(){
    try {
      if (qrScanner) { await qrScanner.stop(); await qrScanner.clear(); }
    } catch {}
    qrScannerActive = false;
    currentTrack = null;
    qrReaderDiv.style.display = 'none';
    qrHint.style.display = 'none';
    scanBarcodeBtn.textContent = '📷 Kamera ile Okut';
    cameraSwitchBtn.style.display = 'none';
    setBarcodeInputReadonly(false);
  }

  function resumeCamera(){
    stopCamera();
    setTimeout(()=> startCamera(), 120);
  }

  function onScanSuccess(code){
    // EAN kontrolü
    if (isFullEAN(code) && !isValidEAN(code)) {
      showErrorPopup("Geçersiz barkod: kontrol basamağı uyuşmuyor.");
      playBeep(false); vibrate(false);
      // popup kapanana kadar akışı durdurma — inline olduğu için devam etsin
      return;
    }
    playBeep(true); vibrate(true);
    manualBarcode.value = code;
    if (isMobile) manualBarcode.blur();
    searchAndShowPopup(code, /*fromCamera*/true);
  }
  function onScanError(_err) { /* sessiz */ }

  // UI events
  scanBarcodeBtn.addEventListener('click', () => { qrScannerActive ? stopCamera() : startCamera(); });
  cameraSwitchBtn.addEventListener('click', () => {
    currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
    resumeCamera();
  });

  // ==== Persistence ====
  function saveToLocalStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
  }
  function loadFromLocalStorage() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) { try { return JSON.parse(data); } catch { return null; } }
    return null;
  }

  // ==== Excel/JSON ====
  document.getElementById('saveJsonBtn').addEventListener('click', saveJson);
  function saveJson() {
    const dataStr = JSON.stringify(products, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'irsaliye_durum.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  document.getElementById('loadJsonBtn').addEventListener('click', () => {
    document.getElementById('loadJsonInput').click();
  });
  document.getElementById('loadJsonInput').addEventListener('change', function(evt){
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const loaded = JSON.parse(e.target.result);
        products = loaded;
        saveToLocalStorage();
        renderProducts();
        alert("JSON başarıyla yüklendi ve uygulandı!");
      } catch {
        alert("Geçersiz JSON dosyası!");
      }
    };
    reader.readAsText(file);
  });

  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (products && products.length > 0) {
      pendingFileForReplace = file;
      showReplaceOverlay();
    } else {
      handleFile(file);
    }
  });
  function showReplaceOverlay(){ replaceOverlay.style.display = 'flex'; }
  closeReplaceBtn.addEventListener('click', () => { replaceOverlay.style.display = 'none'; pendingFileForReplace=null; fileInput.value=''; });
  btnCancelReplace.addEventListener('click', () => { replaceOverlay.style.display = 'none'; pendingFileForReplace=null; fileInput.value=''; });
  btnSaveJsonInPopup.addEventListener('click', () => saveJson());
  btnContinueReplace.addEventListener('click', () => {
    replaceOverlay.style.display = 'none';
    if (pendingFileForReplace) {
      handleFile(pendingFileForReplace);
      pendingFileForReplace = null;
    }
  });

  function handleFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      products = XLSX.utils.sheet_to_json(sheet, {defval: ""});
      const saved = loadFromLocalStorage();
      if (saved) {
        products.forEach(p => {
          const key = String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "");
          const match = saved.find(s => String(s.Barkodu || s["BARKODU"] || s["Barkod"] || "") === key);
          if (match) {
            p.scanned = !!match.scanned;
            p.receivedQty = (match.receivedQty !== undefined) ? match.receivedQty : null;
            p.reportedBy  = match.reportedBy || "";
            p.errorType   = match.errorType || "";
            p.errorNote   = match.errorNote || "";
          } else {
            p.scanned = false; p.receivedQty = null; p.reportedBy=""; p.errorType=""; p.errorNote="";
          }
        });
      } else {
        products.forEach(p => { p.scanned = false; p.receivedQty = null; p.reportedBy=""; p.errorType=""; p.errorNote=""; });
      }
      renderProducts();
    };
    reader.readAsArrayBuffer(file);
  }

  // ==== UI Render ====
  function renderProducts(list = null) {
    const data = list || products;
    const sortedData = data.slice().sort((a,b)=>{
      const as = (a.scanned === true) ? 2 : ((a.scanned === false) || (a.receivedQty !== null && a.receivedQty !== undefined)) ? 1 : 0;
      const bs = (b.scanned === true) ? 2 : ((b.scanned === false) || (b.receivedQty !== null && b.receivedQty !== undefined)) ? 1 : 0;
      if (as !== bs) return as - bs;
      const ab = String(a.Barkodu || a["BARKODU"] || a["Barkod"] || "");
      const bb = String(b.Barkodu || b["BARKODU"] || b["Barkod"] || "");
      return ab.localeCompare(bb, 'tr');
    });
    productList.innerHTML = '';
    sortedData.forEach(p => {
      const barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
      const urunAdi = p["Stok Adı"] || p["STOK ADI"] || "";
      const adet = p.Miktarı || p["Miktar"] || p["MİKTARI"] || "";
      const div = document.createElement('div');
      div.className = 'item';
      div.setAttribute('data-barcode', barkod);
      if (p.scanned === true) { div.classList.add('scanned'); }
      else if (p.scanned === false && (p.receivedQty !== null && p.receivedQty !== undefined)) { div.classList.add('incorrect'); }
      div.innerHTML = `<span><b>${barkod}</b> - ${urunAdi}</span><span><b>${adet} ADET</b></span>`;
      div.addEventListener('click', () => openPopup(p));
      productList.appendChild(div);
    });
    updateCounter();
  }

  function openPopup(product) {
    currentProduct = product;
    popupProductName.textContent = product["Stok Adı"] || "Ürün Adı Yok";
    popupBarcode.textContent = "Barkod: " + (product.Barkodu || product["BARKODU"] || product["Barkod"] || "");
    popupProductQty.textContent = "Olması Gereken: " + (product.Miktarı || product["Miktar"] || product["MİKTARI"] || "") + " ADET";
    popupOverlay.style.display = 'flex';
  }

  correctBtn.addEventListener('click', () => {
    if (!currentProduct) return;
    currentProduct.scanned = true;
    currentProduct.receivedQty = null;
    currentProduct.reportedBy = "";
    currentProduct.errorType = "";
    currentProduct.errorNote = "";
    const itemDiv = document.querySelector(`[data-barcode='${currentProduct.Barkodu || currentProduct["BARKODU"] || currentProduct["Barkod"] || ""}']`);
    if (itemDiv) { itemDiv.classList.remove('incorrect'); itemDiv.classList.add('scanned'); }
    saveToLocalStorage();
    popupOverlay.style.display = 'none';
    updateCounter();
    checkIfDone();
    // Kamera açıksa otomatik devam
    if (qrScannerActive) resumeCamera();
    currentProduct = null;
  });

  incorrectBtn.addEventListener('click', () => {
    if (!currentProduct) return;
    incProductName.value = currentProduct["Stok Adı"] || "";
    incBarcode.value = currentProduct.Barkodu || currentProduct["BARKODU"] || currentProduct["Barkod"] || "";
    incExpected.value = currentProduct.Miktarı || currentProduct["Miktar"] || currentProduct["MİKTARI"] || 0;
    incReceived.value = ""; incReporter.value = "";
    incType.value = ""; incNote.value = "";
    popupOverlay.style.display = 'none';
    incorrectOverlay.style.display = 'flex';
  });

  document.getElementById('btnSaveIncorrect').addEventListener('click', () => {
    if (!currentProduct) return;
    const rec = parseInt(incReceived.value,10);
    const who = (incReporter.value || "").trim();
    const typ = (incType.value || "").trim();
    if (isNaN(rec) || rec < 0) { alert("Gelen adet geçersiz."); return; }
    if (!who) { alert("Hata bildiren zorunlu."); return; }
    if (!typ) { alert("Hata tipi zorunlu."); return; }
    currentProduct.scanned = false;
    currentProduct.receivedQty = rec;
    currentProduct.reportedBy = who;
    currentProduct.errorType = typ;
    currentProduct.errorNote = (incNote.value || "").trim();
    saveToLocalStorage();
    const itemDiv = document.querySelector(`[data-barcode='${currentProduct.Barkodu || currentProduct["BARKODU"] || currentProduct["Barkod"] || ""}']`);
    if (itemDiv) { itemDiv.classList.remove('scanned'); itemDiv.classList.add('incorrect'); }
    incorrectOverlay.style.display = 'none';
    if (qrScannerActive) resumeCamera();
    currentProduct = null;
  });

  // Popuplar kapat
  closePopupBtn.addEventListener('click', () => { popupOverlay.style.display = 'none'; currentProduct = null; if (qrScannerActive) resumeCamera(); });
  document.getElementById('btnCancelIncorrect').addEventListener('click', () => { incorrectOverlay.style.display = 'none'; currentProduct = null; if (qrScannerActive) resumeCamera(); });
  closeIncorrectBtn.addEventListener('click', () => { incorrectOverlay.style.display = 'none'; currentProduct = null; if (qrScannerActive) resumeCamera(); });

  // Eksikler: sadece hatalılar
  missingBtn.addEventListener('click', () => {
    buildMissingList();
    missingOverlay.style.display = 'flex';
  });
  function buildMissingList(){
    missingList.innerHTML = '';
    const hatalilar = products.filter(p => p.scanned === false && (p.receivedQty !== null && p.receivedQty !== undefined));
    if (!hatalilar.length) {
      missingList.innerHTML = "<p>Hatalı kayıt yok ✅</p>";
      return;
    }
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.innerHTML = `
      <thead>
        <tr>
          <th style="border-bottom:1px solid #ddd; text-align:left; padding:6px;">Barkod</th>
          <th style="border-bottom:1px solid #ddd; text-align:left; padding:6px;">Ürün Adı</th>
          <th style="border-bottom:1px solid #ddd; text-align:right; padding:6px;">Gelmesi Gereken</th>
          <th style="border-bottom:1px solid #ddd; text-align:right; padding:6px;">Gelen Adet</th>
          <th style="border-bottom:1px solid #ddd; text-align:left; padding:6px;">Hata Bildiren</th>
          <th style="border-bottom:1px solid #ddd; text-align:left; padding:6px;">Hata Tipi</th>
          <th style="border-bottom:1px solid #ddd; text-align:left; padding:6px;">Açıklama</th>
        </tr>
      </thead>
      <tbody>
        ${hatalilar.map(p=>{
          const barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
          const urun = p["Stok Adı"] || p["STOK ADI"] || "";
          const exp = p.Miktarı || p["Miktar"] || p["MİKTARI"] || 0;
          const rec = (p.receivedQty!=null)? p.receivedQty : "";
          const who = p.reportedBy || "";
          const typ = p.errorType || "";
          const note = p.errorNote || "";
          return `<tr>
            <td style="border-bottom:1px solid #eee; padding:6px;">${barkod}</td>
            <td style="border-bottom:1px solid #eee; padding:6px;">${urun}</td>
            <td style="border-bottom:1px solid #eee; padding:6px; text-align:right;">${exp}</td>
            <td style="border-bottom:1px solid #eee; padding:6px; text-align:right; font-size:20px; font-weight:bold;">${rec}</td>
            <td style="border-bottom:1px solid #eee; padding:6px;">${who}</td>
            <td style="border-bottom:1px solid #eee; padding:6px;">${typ}</td>
            <td style="border-bottom:1px solid #eee; padding:6px;">${note}</td>
          </tr>`;
        }).join('')}
      </tbody>
    `;
    missingList.appendChild(table);
  }
  btnPrintMissing.addEventListener('click', () => openMissingPrintWindow(true));
  btnExportPdf.addEventListener('click', () => openMissingPrintWindow(false));
  function openMissingPrintWindow(autoPrint){
    const hatalilar = products.filter(p => p.scanned === false && (p.receivedQty !== null && p.receivedQty !== undefined));
    const w = window.open('', '', 'height=900,width=700');
    w.document.write(`<html><head><title>Hatalı Ürünler</title>
    <style>
      @page { size: A4; margin: 16mm; }
      body { font-family: Arial, sans-serif; color:#111; }
      h2 { text-align:center; margin: 0 0 12px; }
      table { width:100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #ddd; padding: 8px; vertical-align: top; }
      th { text-align:left; }
      td.num { text-align:right; }
      td.big { font-size:20px; font-weight:700; }
    </style></head><body>`);
    w.document.write(`<h2>Hatalı Ürünler Listesi</h2>`);
    if (!hatalilar.length) {
      w.document.write(`<p>Hatalı kayıt yok.</p>`);
    } else {
      w.document.write(`<table>
        <thead>
          <tr>
            <th>Barkod</th><th>Ürün Adı</th><th class="num">Gelmesi Gereken</th><th class="num">Gelen Adet</th><th>Hata Bildiren</th><th>Hata Tipi</th><th>Açıklama</th>
          </tr>
        </thead>
        <tbody>
          ${hatalilar.map(p=>{
            const barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
            const urun = p["Stok Adı"] || p["STOK ADI"] || "";
            const exp = p.Miktarı || p["Miktar"] || p["MİKTARI"] || 0;
            const rec = (p.receivedQty!=null)? p.receivedQty : "";
            const who = p.reportedBy || "";
            const typ = p.errorType || "";
            const note = p.errorNote || "";
            return `<tr>
              <td>${barkod}</td>
              <td>${urun}</td>
              <td class="num">${exp}</td>
              <td class="num big">${rec}</td>
              <td>${who}</td>
              <td>${typ}</td>
              <td>${note}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>`);
    }
    w.document.write(`</body></html>`);
    w.document.close();
    if (autoPrint) w.print();
  }

  // Eski yazdır (genel liste)
  document.getElementById('printBtn').addEventListener('click', () => {
    const eksikler = products.filter(p => p.scanned !== true);
    let printWindow = window.open('', '', 'height=800,width=600');
    printWindow.document.write('<html><head><title>Eksik Ürünler</title></head><body>');
    printWindow.document.write('<h2>Eksik Ürünler Listesi</h2><ul>');
    eksikler.forEach(p => {
      printWindow.document.write(`<li>${p.Barkodu || p["BARKODU"] || p["Barkod"]} - ${p["Stok Adı"] || p["STOK ADI"]} (${p.Miktarı || p["Miktar"] || p["MİKTARI"]} ADET)</li>`);
    });
    printWindow.document.write('</ul></body></html>');
    printWindow.document.close();
    printWindow.print();
  });

  // Excel’e Aktar
  document.getElementById('exportBtn').addEventListener('click', () => {
    const exportData = products.map(p => ({
      Barkod: p.Barkodu || p["BARKODU"] || p["Barkod"],
      "Ürün Adı": p["Stok Adı"] || p["STOK ADI"],
      Durum: p.scanned ? "Doğru" : "Hatalı",
      "Olması Gereken": p.Miktarı || p["Miktar"] || p["MİKTARI"],
      "Gelen Adet": p.receivedQty ?? "",
      "Hata Bildiren": p.reportedBy ?? "",
      "Hata Tipi": p.errorType ?? "",
      "Açıklama": p.errorNote ?? ""
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kontrol Listesi");
    XLSX.writeFile(wb, "irsaliye_kontrol.xlsx");
  });

  function updateCounter() {
    const total = products.length;
    const done = products.filter(p => p.scanned === true).length;
    progressEl.textContent = `✔️ ${done} / ${total} ürün tamamlandı`;
  }
  function checkIfDone() {
    const total = products.length;
    const done = products.filter(p => p.scanned === true).length;
    if (total > 0 && done === total) {
      doneOverlay.style.display = 'flex';
      setTimeout(()=> doneOverlay.style.display='none', 3000);
    }
  }

  // --- Arama Motoru (tam barkod, son 6, isim)
  function searchProduct(term) {
    if (!term) return null;
    term = term.trim().toLowerCase();
    let found = products.find(p => {
      const b = String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "").toLowerCase();
      return b === term || b.slice(-6) === term;
    });
    if (found) return found;
    found = products.find(p => (p["Stok Adı"] || p["STOK ADI"] || "").toLowerCase().includes(term));
    return found || null;
  }

  // QuickSearch — kamera açıkken de aktif
  quickSearch.addEventListener('input', function(){
    const val = quickSearch.value.trim().toLowerCase();
    if (!val || !products.length) { searchResults.innerHTML = ""; return; }
    let results = products.filter(p => {
      let barkod = String(p.Barkodu || p["BARKODU"] || p["Barkod"] || "").toLowerCase();
      let urunAdi = (p["Stok Adı"] || p["STOK ADI"] || "").toLowerCase();
      return barkod.includes(val) || barkod.slice(-6).includes(val) || urunAdi.includes(val);
    });
    if (results.length === 1 && val.length > 2) {
      openPopup(results[0]);
      searchResults.innerHTML = "";
      playBeep(true); vibrate(true);
      return;
    }
    searchResults.innerHTML = results.slice(0,8).map(p=>{
      let barkod = p.Barkodu || p["BARKODU"] || p["Barkod"] || "";
      let urunAdi = p["Stok Adı"] || p["STOK ADI"] || "";
      let adet = p.Miktarı || p["Miktar"] || p["MİKTARI"] || "";
      return `<div class="item" onclick="window._popupByIdx(${products.indexOf(p)})"><b>${barkod}</b> - ${urunAdi} <b>(${adet})</b></div>`;
    }).join('');
  });
  window._popupByIdx = idx => {
    let p = products[idx];
    if (p) {
      openPopup(p);
      quickSearch.value = "";
      searchResults.innerHTML = "";
      playBeep(true); vibrate(true);
    }
  };

  // PC alanı — Enter ile tetiklenir
  manualBarcode.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      let code = manualBarcode.value.trim();
      manualBarcode.value = '';
      if (!code) return;
      if (isFullEAN(code) && !isValidEAN(code)) {
        showErrorPopup("Geçersiz barkod: kontrol basamağı uyuşmuyor.");
        playBeep(false); vibrate(false);
        return;
      }
      searchAndShowPopup(code, false);
    }
  });

  // EAN kontrol yardımcıları
  function isFullEAN(val){
    const s = String(val).trim();
    return /^\d{13}$/.test(s) || /^\d{8}$/.test(s);
  }
  function isValidEAN(val){
    const s = String(val).trim();
    if (/^\d{13}$/.test(s)) {
      const digits = s.split('').map(Number);
      let sum = 0;
      for (let i=0;i<12;i++){ sum += digits[i] * (i%2===0 ? 1 : 3); }
      const check = (10 - (sum % 10)) % 10;
      return check === digits[12];
    }
    if (/^\d{8}$/.test(s)) {
      const d = s.split('').map(Number);
      let sum = d[0]*3 + d[1]*1 + d[2]*3 + d[3]*1 + d[4]*3 + d[5]*1 + d[6]*3;
      const check = (10 - (sum % 10)) % 10;
      return check === d[7];
    }
    return false;
  }

  // Bul ve popup aç
  function searchAndShowPopup(val, fromCamera = false) {
    let found = searchProduct(val);
    // Daha önce onaylandıysa özel popup aç
    if (found && found.scanned === true) { showAlreadyApproved(found, fromCamera); playBeep(true); vibrate(true); return; }
    if (!found) {
      showErrorPopup("Bu ürün listede yok.");
      playBeep(false); vibrate(false);
      return;
    }
    openPopup(found);
    playBeep(true); vibrate(true);
  }

  // Hata Pop-up
  function showErrorPopup(msg){
    document.getElementById('errorText').textContent = msg || "Hata oluştu.";
    errorOverlay.style.display = 'flex';
  }
  document.getElementById('closeErrorBtn').addEventListener('click', () => {
    errorOverlay.style.display = 'none';
  });

  // Onaylı ürünü tekrar okutma popup'ı
  function showAlreadyApproved(product, fromCamera=false) {
    currentProduct = product;
    const name = product["Stok Adı"] || "Ürün";
    const barkod = product.Barkodu || product["BARKODU"] || product["Barkod"] || "";
    document.getElementById('approvedText').textContent = `${name} (${barkod}) daha önce 'Adet Doğru' olarak onaylandı. Hata bildirmek ister misin?`;
    approvedOverlay.style.display = 'flex';
  }
  document.getElementById('approvedDismissBtn').addEventListener('click', () => {
    approvedOverlay.style.display = 'none';
  });
  document.getElementById('closeApprovedBtn').addEventListener('click', () => {
    approvedOverlay.style.display = 'none';
  });
  document.getElementById('approvedReportBtn').addEventListener('click', () => {
    approvedOverlay.style.display = 'none';
    if (currentProduct) { openIncorrectFor(currentProduct); }
  });
  function openIncorrectFor(product) {
    currentProduct = product;
    incProductName.value = product["Stok Adı"] || "";
    incBarcode.value   = product.Barkodu || product["BARKODU"] || product["Barkod"] || "";
    incExpected.value  = product.Miktarı || product["Miktar"] || product["MİKTARI"] || 0;
    incReceived.value  = (product.receivedQty != null) ? product.receivedQty : 0;
    incType.value      = product.errorType || "";
    incReporter.value  = product.reportedBy || "";
    incNote.value      = product.errorNote || "";
    incorrectOverlay.style.display = 'flex';
    popupOverlay.style.display = 'none';
  }

  // Sıfırla
  resetBtn.addEventListener('click', () => {
    if(confirm("Tüm işaretlemeleri sıfırlamak istediğine emin misin?")) {
      products.forEach(p => { p.scanned = false; p.receivedQty = null; p.reportedBy = ""; p.errorType=""; p.errorNote=""; });
      saveToLocalStorage();
      renderProducts();
    }
  });

  // İlk yüklenişte varsa local storage'tan getir
  (function initFromStorage(){
    const saved = loadFromLocalStorage();
    if (saved && saved.length) {
      products = saved;
      renderProducts();
    }
  })();

})(); // IIFE
</script>
</body>
</html>
